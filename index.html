// Statistics Manager Class
class StatisticsManager {
    constructor() {
        this.sessionStartTime = null;
        this.timerInterval = null;
        this.stats = this.loadStats();
        this.todayStats = this.loadTodayStats();
        this.checkOngoingSession();

        this.currentSessionMistakes = 0;

        this.bindEvents();
        this.checkDayReset();
        this.updateUI();
    }

    loadStats() {
        return JSON.parse(localStorage.getItem('practiceStats')) || {
            streak: 0,
            totalPractices: 0,
            lastPracticeDate: null,
            practiceHistory: []
        };
    }

    loadTodayStats() {
        const today = new Date().toDateString();
        const saved = JSON.parse(localStorage.getItem('todayStats')) || {};
        
        if (saved.date !== today) {
            return {
                date: today,
                practiceTime: 0,
                mistakes: [],
                sentences: 0,
                firstTrySuccesses: 0
            };
        }
        return saved;
    }

    saveTodayStats() {
        localStorage.setItem('todayStats', JSON.stringify(this.todayStats));
    }

    saveStats() {
        localStorage.setItem('practiceStats', JSON.stringify(this.stats));
    }

   bindEvents() {
        document.getElementById('stats-dashboard-btn').addEventListener('click', () => {
            const dashboard = document.getElementById('statistics-dashboard');
            const button = document.getElementById('stats-dashboard-btn');
            
            if (dashboard.classList.contains('open')) {
                dashboard.classList.remove('open');
                button.classList.remove('active');
            } else {
                dashboard.classList.add('open');
                button.classList.add('active');
                this.updateUI();
            }
        });

        document.getElementById('close-stats-btn').addEventListener('click', () => {
            document.getElementById('statistics-dashboard').classList.remove('open');
            document.getElementById('stats-dashboard-btn').classList.remove('active');
        });

        window.addEventListener('focus', () => this.checkDayReset());
        window.addEventListener('beforeunload', () => this.saveSessionTime());
    }

  startTimer() {
        if (this.timerInterval) return;

        if (!this.sessionStartTime) {
            this.sessionStartTime = Date.now();
            localStorage.setItem('sessionStartTime', this.sessionStartTime);
        }

        this.timerInterval = setInterval(() => this.updatePracticeTime(), 1000); // Update every second for accuracy
    }



    stopTimer() {
        if (!this.timerInterval) return;

        clearInterval(this.timerInterval);
        this.timerInterval = null;

        if (this.sessionStartTime) {
            this.updatePracticeTime(true); // Save final time
            this.sessionStartTime = null;
            localStorage.removeItem('sessionStartTime'); // Clear start time from localStorage
        }
    }

 updatePracticeTime(isFinal = false) {
        const elapsedMinutes = Math.floor((Date.now() - this.sessionStartTime) / 60000);
        this.todayStats.practiceTime = elapsedMinutes;
        if (isFinal) this.saveTodayStats(); // Save only at the end to minimize storage writes
        this.updateUI();
    }

 checkOngoingSession() {
        const savedStartTime = localStorage.getItem('sessionStartTime');
        if (savedStartTime) {
            this.sessionStartTime = Number(savedStartTime);
            this.startTimer();
        }
    }


    checkDayReset() {
        const today = new Date().toDateString();
        const lastReset = localStorage.getItem('lastStatsReset');

        if (lastReset !== today) {
            this.todayStats = {
                date: today,
                practiceTime: 0,
                mistakes: [],
                sentences: 0,
                firstTrySuccesses: 0
            };
            
            this.saveTodayStats();
            localStorage.setItem('lastStatsReset', today);
            this.stopTimer();
            this.updateUI();
        }
    }

    formatTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours}h ${mins}m`;
    }

    updateUI() {
        document.getElementById('streak-count').textContent = `${this.stats.streak} days`;
        document.getElementById('practice-time').textContent = this.formatTime(this.todayStats.practiceTime);
        document.getElementById('total-practices').textContent = this.stats.totalPractices;

        const successRate = this.todayStats.sentences > 0
            ? Math.round((this.todayStats.firstTrySuccesses / this.todayStats.sentences) * 100)
            : 0;
        document.getElementById('success-rate').textContent = `${successRate}%`;

        const mistakesList = document.getElementById('recent-mistakes');
        if (this.todayStats.mistakes.length > 0) {
            mistakesList.innerHTML = this.todayStats.mistakes
                .map(mistake => `
                    <div class="mistake-item">
                        <div style="color: #EF4444;">Incorrect: ${mistake.incorrect}</div>
                        <div style="color: #10B981;">Correct: ${mistake.correct}</div>
                        <div style="color: #6B7280; font-size: 0.8rem;">
                            ${new Date(mistake.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `).join('');
        } else {
            mistakesList.innerHTML = '<p class="empty-state">No mistakes recorded today</p>';
        }

        const historyList = document.getElementById('practice-history');
        if (this.stats.practiceHistory.length > 0) {
            historyList.innerHTML = this.stats.practiceHistory
                .map(session => `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${new Date(session.date).toLocaleDateString()}</span>
                            <span>${session.sentences} sentences</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <div style="color: #6B7280; font-size: 0.875rem;">
                                Time: ${this.formatTime(session.duration)}
                            </div>
                            <div style="color: ${session.mistakes === 0 ? '#10B981' : '#EF4444'}; font-size: 0.875rem;">
                                Mistakes: ${session.mistakes}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 4px;">
                            <div style="font-size: 0.875rem;">
                                Success Rate: <span style="color: ${
                                    session.successRate >= 80 ? '#10B981' : 
                                    session.successRate >= 50 ? '#FCD34D' : '#EF4444'
                                }">${session.successRate}%</span>
                            </div>
                        </div>
                    </div>
                `).join('');
        } else {
            historyList.innerHTML = '<p class="empty-state">No practice history available</p>';
        }
    }

    startPracticeSession() {
        this.startTimer();
        this.updateStreak();
        this.currentSessionMistakes = 0;
        this.todayStats.sentences = 0;
        this.todayStats.firstTrySuccesses = 0;
        this.saveTodayStats();
        this.saveStats();
        this.updateUI();
    }

    endPracticeSession(completedSentences) {
        this.stopTimer();
        this.stats.totalPractices++;

        const successRate = this.todayStats.sentences > 0
            ? Math.round((this.todayStats.firstTrySuccesses / this.todayStats.sentences) * 100)
            : 0;

        this.stats.practiceHistory.unshift({
            date: new Date().toISOString(),
            sentences: completedSentences,
            duration: this.todayStats.practiceTime,
            mistakes: this.currentSessionMistakes,
            successRate: successRate
        });

        this.stats.practiceHistory = this.stats.practiceHistory.slice(0, 30);
        
        this.saveStats();
        this.updateUI();
    }

    updateStreak() {
        const today = new Date().toDateString();
        const lastPractice = this.stats.lastPracticeDate ? 
            new Date(this.stats.lastPracticeDate).toDateString() : null;

        if (!lastPractice) {
            this.stats.streak = 1;
        } else if (lastPractice === today) {
            return;
        } else {
            const daysDiff = (new Date(today) - new Date(lastPractice)) / (1000 * 60 * 60 * 24);
            this.stats.streak = daysDiff === 1 ? this.stats.streak + 1 : 1;
        }

        this.stats.lastPracticeDate = new Date().toISOString();
        this.saveStats();
    }

    recordMistake(incorrect, correct) {
        const mistake = {
            incorrect,
            correct,
            timestamp: new Date().toISOString()
        };
        
        this.todayStats.mistakes.unshift(mistake);
        this.todayStats.sentences++;
        this.currentSessionMistakes++;
        this.saveTodayStats();
        this.updateUI();
    }

    recordFirstTrySuccess() {
        this.todayStats.sentences++;
        this.todayStats.firstTrySuccesses++;
        this.saveTodayStats();
        this.updateUI();
    }

 resetDailyStats() {
        this.stopTimer();
        this.currentSessionMistakes = 0;
        this.todayStats.sentences = 0;
        this.todayStats.firstTrySuccesses = 0;
        this.todayStats.practiceTime = 0;
        this.sessionStartTime = null;
        this.timerInterval = null;
        this.saveTodayStats();
        this.updateUI();
    }
}

// Initialize statistics manager
const statisticsManager = new StatisticsManager();
window.statisticsManager = statisticsManager;
